<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Dynamiczna Symulacja Wiatru</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #0A0F1E; /* Ciemniejsze tło */
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        main { 
            box-shadow: 0 0 30px rgba(0,0,0,0.7); 
            border: 1px solid #222;
        }
        .info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            background-color: rgba(0,0,0,0.3);
            padding: 5px 10px;
            border-radius: 5px;
        }
        .loader {
            color: white;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div id="loader" class="loader">Ładowanie danych symulacji...</div>
    <main style="display: none;"></main> <div id="info-box" class="info" style="display: none;"></div>

<script>
    // --- USTAWIENIA SYMULACJI ---
    const LICZBA_CZASTECZEK = 2500;
    const ZAKLOCENIE_WIATRU = 0.5; // Jak bardzo wiatr jest "burzliwy"
    
    let daneSymulacji;
    let budynki = [];
    let czasteczki = [];
    let predkoscWiatru = 1;
    let kierunekWiatruRad = 0;
    let infoBox;

    function preload() {
        let url = 'wyniki/simulation_data.json';
        daneSymulacji = loadJSON(url, onDataLoaded, onDataError);
    }

    function onDataLoaded() {
        console.log("Dane pomyślnie załadowane.");
        document.getElementById('loader').style.display = 'none';
        document.querySelector('main').style.display = 'block';
        document.getElementById('info-box').style.display = 'block';
    }

    function onDataError() {
        console.error("Błąd ładowania pliku simulation_data.json");
        document.getElementById('loader').innerText = 'Błąd: Nie można załadować danych symulacji. Sprawdź, czy plik istnieje i czy skrypt backendowy działa poprawnie.';
    }

    class Czasteczka {
        constructor() { this.reset(); }
        reset() { 
            this.x = random(width); 
            this.y = random(height); 
            this.historia = [];
            this.predkosc = createVector(0,0);
        }
        update() {
            let bazowyWektor = p5.Vector.fromAngle(kierunekWiatruRad);
            let katZaklocenia = noise(this.x * 0.004, this.y * 0.004) * TWO_PI * ZAKLOCENIE_WIATRU;
            let wektorZaklocenia = p5.Vector.fromAngle(katZaklocenia);
            
            bazowyWektor.add(wektorZaklocenia).normalize().mult(predkoscWiatru);
            this.predkosc.add(bazowyWektor).limit(predkoscWiatru * 1.5);

            this.x += this.predkosc.x;
            this.y += this.predkosc.y;
            
            for (let bud of budynki) {
                if (this.x > bud.x && this.x < bud.x + bud.w && this.y > bud.y && this.y < bud.y + bud.h) {
                    this.reset();
                }
            }
            this.historia.push(createVector(this.x, this.y));
            if (this.historia.length > 30) { this.historia.splice(0, 1); }
            if (this.x > width + 10 || this.x < -10 || this.y > height + 10 || this.y < -10) { this.reset(); }
        }
        show() {
            noFill();
            beginShape();
            for (let i = 0; i < this.historia.length; i++) {
                let pos = this.historia[i];
                let alpha = map(i, 0, this.historia.length, 0, 180);
                stroke(200, 220, 255, alpha);
                vertex(pos.x, pos.y);
            }
            endShape();
            fill(255);
            noStroke();
            ellipse(this.x, this.y, 2, 2);
        }
    }

    function setup() {
        if (!daneSymulacji) {
            console.error("Setup przerwany: dane nie zostały załadowane.");
            let canvas = createCanvas(1, 1); // Stwórz minimalne płótno, aby uniknąć błędów
            canvas.parent('main');
            noLoop(); // Zatrzymaj pętlę draw()
            return;
        }

        let canvasW = daneSymulacji.canvas_dimensions.width;
        let canvasH = daneSymulacji.canvas_dimensions.height;
        let canvas = createCanvas(canvasW, canvasH);
        canvas.parent('main');
        
        budynki = daneSymulacji.buildings;
        predkoscWiatru = daneSymulacji.weather.wind_speed / 4.0;
        kierunekWiatruRad = radians(daneSymulacji.weather.wind_direction - 180);

        infoBox = document.getElementById('info-box');
        infoBox.innerHTML = `Dane pogodowe: ${daneSymulacji.weather.temperature}°C, wiatr ${daneSymulacji.weather.wind_speed} m/s, kier. ${daneSymulacji.weather.wind_direction}°`;

        for (let i = 0; i < LICZBA_CZASTECZEK; i++) {
            czasteczki.push(new Czasteczka());
        }
    }

    function draw() {
        if (!daneSymulacji) return; // Nie rysuj nic, jeśli dane nie są gotowe

        background(10, 15, 30, 180); // Dodanie przezroczystości dla efektu "smugi"
        
        fill(5, 8, 15, 200);
        stroke(120);
        for (let bud of budynki) {
            rect(bud.x, bud.y, bud.w, bud.h);
        }
        
        for (let cz of czasteczki) {
            cz.update();
            cz.show();
        }
    }
</script>
</body>
</html>
