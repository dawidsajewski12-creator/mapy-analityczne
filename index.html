<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Dynamiczna Symulacja Wiatru</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #0A0F1E;
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        main { 
            box-shadow: 0 0 30px rgba(0,0,0,0.7); 
            border: 1px solid #222;
        }
        .info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            background-color: rgba(0,0,0,0.3);
            padding: 5px 10px;
            border-radius: 5px;
        }
        .loader {
            color: white;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div id="loader" class="loader">Ładowanie danych symulacji...</div>
    <main style="display: none;"></main>
    <div id="info-box" class="info" style="display: none;"></div>

<script>
    // --- USTAWIENIA SYMULACJI ---
    const LICZBA_CZASTECZEK = 2500;
    const ZAKLOCENIE_WIATRU = 0.5;
    
    let daneSymulacji;
    let budynki = [];
    let czasteczki = [];
    let predkoscWiatru = 1;
    let kierunekWiatruRad = 0;
    let infoBox;
    let canvasCreated = false;

    function preload() {
        let url = 'wyniki/simulation_data.json';
        // Fallback do danych testowych w przypadku błędu
        httpGet(url, 'json', onDataLoaded, onDataError);
    }

    function onDataLoaded(data) {
        daneSymulacji = data;
        console.log("Dane pomyślnie załadowane:", data);
        document.getElementById('loader').style.display = 'none';
        document.querySelector('main').style.display = 'block';
        document.getElementById('info-box').style.display = 'block';
    }

    function onDataError(error) {
        console.error("Błąd ładowania pliku simulation_data.json:", error);
        // Użyj danych testowych
        daneSymulacji = {
            canvas_dimensions: { width: 1200, height: 800 },
            buildings: [
                {x: 100, y: 100, w: 80, h: 60},
                {x: 300, y: 200, w: 120, h: 80},
                {x: 600, y: 150, w: 100, h: 100},
                {x: 900, y: 300, w: 90, h: 70}
            ],
            weather: {
                temperature: 15.0,
                humidity: 60,
                wind_speed: 5.0,
                wind_direction: 270,
                timestamp: new Date().toISOString()
            }
        };
        
        document.getElementById('loader').innerHTML = 'Używanie danych testowych (brak pliku simulation_data.json)';
        setTimeout(() => {
            document.getElementById('loader').style.display = 'none';
            document.querySelector('main').style.display = 'block';
            document.getElementById('info-box').style.display = 'block';
        }, 1000);
    }

    class Czasteczka {
        constructor() { 
            this.reset(); 
        }
        
        reset() { 
            this.x = random(width); 
            this.y = random(height); 
            this.historia = [];
            this.predkosc = createVector(0, 0);
            this.zycie = random(300, 600); // Czas życia cząsteczki
            this.wiek = 0;
        }
        
        update() {
            this.wiek++;
            if (this.wiek > this.zycie) {
                this.reset();
                return;
            }
            
            // Podstawowy wektor wiatru
            let bazowyWektor = p5.Vector.from
