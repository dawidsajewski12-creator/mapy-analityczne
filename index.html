<!DOCTYPE html>
<html lang="pl">
<head>
    <title>Mapy Analityczne - Pokrycie Terenu + NMT + NMPT + Budynki</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <style>
        html, body, #map { 
            height: 100%; 
            width: 100%; 
            margin: 0; 
            background: linear-gradient(135deg, #1e3c72, #2a5298); 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .leaflet-control-layers {
            background: rgba(255,255,255,0.95) !important;
            backdrop-filter: blur(10px);
            border-radius: 12px !important;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1) !important;
            border: 1px solid rgba(255,255,255,0.18);
            padding: 10px;
            font-size: 14px;
        }
        
        .leaflet-control-layers-toggle {
            background-color: rgba(59, 130, 246, 0.9) !important;
            border-radius: 8px;
        }
        
        .leaflet-control-layers label {
            color: #334155 !important;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        .leaflet-control-layers label:hover {
            color: #1e40af !important;
        }
        
        .legend {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.18);
            max-width: 300px;
            font-size: 13px;
        }
        
        .legend .title {
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
            font-size: 16px;
            color: #1e40af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 10px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .legend .gradient-bar {
            width: 100%;
            height: 20px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .legend .gradient-labels {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #666;
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.18);
        }
        
        .legend, .leaflet-control-layers {
            animation: fadeInScale 0.3s ease-out;
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>
<body>
<div id="map"></div>
<script>
    const map = L.map('map', {
        zoomControl: false
    }).setView([54.16, 19.40], 13);
    
    L.control.zoom({
        position: 'topright'
    }).addTo(map);
    
    // Ciemna mapa bazowa
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '¬© OpenStreetMap contributors, ¬© CARTO',
        maxZoom: 19
    }).addTo(map);

    const overlayLayers = {
        "üèóÔ∏è Pokrycie terenu": L.tileLayer('./wyniki/kafelki/landcover/{z}/{x}/{y}.png', { 
            tms: true, 
            opacity: 0.8 
        }),
        "üè¢ Budynki (wysoko≈õƒá)": L.tileLayer('./wyniki/kafelki/buildings/{z}/{x}/{y}.png', { 
            tms: true, 
            opacity: 0.85 
        }),
        "üèîÔ∏è NMT (Model Terenu)": L.tileLayer('./wyniki/kafelki/nmt/{z}/{x}/{y}.png', { 
            tms: true, 
            opacity: 0.7 
        }),
        "üèôÔ∏è NMPT (Model Pokrycia)": L.tileLayer('./wyniki/kafelki/nmpt/{z}/{x}/{y}.png', { 
            tms: true, 
            opacity: 0.7 
        })
    };
    
    const layerControl = L.control.layers(null, overlayLayers, { 
        collapsed: false,
        position: 'topleft'
    }).addTo(map);

    const legendControl = L.control({ position: "bottomright" });
    legendControl.onAdd = function() {
        const div = L.DomUtil.create("div", "legend-placeholder");
        return div;
    };
    legendControl.addTo(map);

    function createLandcoverLegend() {
        const div = L.DomUtil.create("div", "legend");
        const items = {
            'Nawierzchnie utwardzone': 'linear-gradient(45deg, #a9a9a9, #808080)',
            'Budynki': 'linear-gradient(45deg, #dc143c, #b91c3c)',
            'Drzewa / Lasy': 'linear-gradient(45deg, #228b22, #166b16)',
            'Trawa / Tereny zielone': 'linear-gradient(45deg, #7cfc00, #65d000)',
            'Gleba / Nieu≈ºytki': 'linear-gradient(45deg, #d2b48c, #c19a6b)',
            'Woda': 'linear-gradient(45deg, #1e90ff, #0066cc)'
        };
        let labels = '<div class="title">Pokrycie terenu</div>';
        for (const [key, gradient] of Object.entries(items)) {
            labels += `<div style="margin-bottom: 8px;"><i style="background:${gradient}"></i>${key}</div>`;
        }
        div.innerHTML = labels;
        return div;
    }

    function createElevationLegend(title, colormap) {
        const div = L.DomUtil.create("div", "legend");
        let gradient;
        
        if (colormap === 'terrain') {
            gradient = 'linear-gradient(to right, #333447 0%, #3b6829 25%, #8b7c4c 50%, #d9d0a8 75%, #ffffff 100%)';
        } else if (colormap === 'viridis') {
            gradient = 'linear-gradient(to right, #440154 0%, #31688e 33%, #35b779 66%, #fde725 100%)';
        } else if (colormap === 'hot') {
            gradient = 'linear-gradient(to right, #0b0000 0%, #aa0000 25%, #ff5500 50%, #ffaa00 75%, #ffffff 100%)';
        }
        
        let html = `<div class="title">${title}</div>`;
        html += `<div class="gradient-bar" style="background: ${gradient};"></div>`;
        html += '<div class="gradient-labels"><span>Min</span><span>Max</span></div>';
        html += '<div style="text-align: center; margin-top: 5px; font-size: 11px; color: #888;">Wysoko≈õƒá [m]</div>';
        
        div.innerHTML = html;
        return div;
    }

    let activeLayers = new Set();

    map.on('overlayadd', (e) => {
        activeLayers.add(e.name);
        updateLegend();
    });

    map.on('overlayremove', (e) => {
        activeLayers.delete(e.name);
        updateLegend();
    });
    
    function updateLegend() {
        const placeholder = document.querySelector('.legend-placeholder');
        placeholder.innerHTML = "";
        
        // Wy≈õwietl tylko jednƒÖ legendƒô - priorytet: NMPT > NMT > Budynki > Pokrycie
        if (activeLayers.has("üèôÔ∏è NMPT (Model Pokrycia)")) {
            placeholder.appendChild(createElevationLegend("NMPT - Model Pokrycia", "viridis"));
        } else if (activeLayers.has("üèîÔ∏è NMT (Model Terenu)")) {
            placeholder.appendChild(createElevationLegend("NMT - Model Terenu", "terrain"));
        } else if (activeLayers.has("üè¢ Budynki (wysoko≈õƒá)")) {
            placeholder.appendChild(createElevationLegend("Wysoko≈õƒá Budynk√≥w", "hot"));
        } else if (activeLayers.has("üèóÔ∏è Pokrycie terenu")) {
            placeholder.appendChild(createLandcoverLegend());
        }
    }
    
    // Domy≈õlnie w≈ÇƒÖcz pokrycie terenu
    overlayLayers["üèóÔ∏è Pokrycie terenu"].addTo(map);
    activeLayers.add("üèóÔ∏è Pokrycie terenu");
    updateLegend();
    
    // Pobierz i wy≈õwietl dane pogodowe
    async function loadWeatherData() {
        try {
            const response = await fetch('./wyniki/weather.json');
            if (response.ok) {
                const data = await response.json();
                document.getElementById('temperature').textContent = data.temperature;
                document.getElementById('humidity').textContent = data.humidity;
                document.getElementById('windSpeed').textContent = data.wind_speed;
                document.getElementById('windDirection').textContent = data.wind_direction;
                document.getElementById('weatherWidget').style.display = 'flex';
            }
        } catch (error) {
            console.log('Brak danych pogodowych');
        }
    }
    
    loadWeatherData();
    // Od≈õwie≈ºaj dane pogodowe co 5 minut
    setInterval(loadWeatherData, 300000);
    // Pobierz i wy≈õwietl dane pogodowe
    async function loadWeatherData() {
        try {
            const response = await fetch('./wyniki/weather.json');
            if (response.ok) {
                const data = await response.json();
                document.getElementById('temperature').textContent = data.temperature;
                document.getElementById('humidity').textContent = data.humidity;
                document.getElementById('windSpeed').textContent = data.wind_speed;
                document.getElementById('windDirection').textContent = data.wind_direction;
                document.getElementById('weatherWidget').style.display = 'flex';
            }
        } catch (error) {
            console.log('Brak danych pogodowych');
        }
    }
    
    loadWeatherData();
    // Od≈õwie≈ºaj dane pogodowe co 5 minut
    setInterval(loadWeatherData, 300000);
</script>
</body>
</html>
